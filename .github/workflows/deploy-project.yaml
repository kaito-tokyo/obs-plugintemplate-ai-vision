name: Deploy Project

on:
  push:
    branches: [main, master, develop]
    tags: ["*"]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

defaults:
  run:
    shell: bash

permissions:
  contents: read

jobs:
  macos-deploy:
    name: macOS Deploy

    runs-on: macos-15
    timeout-minutes: 30
    environment: production-macos

    permissions:
      contents: read

    env:
      HOMEBREW_NO_ANALYTICS: 1
      HOMEBREW_NO_AUTO_UPDATE: 1
      HOMEBREW_NO_ENV_HINTS: 1
      HOMEBREW_NO_INSTALL_CLEANUP: 1
      CODESIGN_OK: ${{ secrets.MACOS_SIGNING_APPLICATION_IDENTITY != '' }}

    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          submodules: recursive

      - name: Read metadata
        id: metadata
        run: |
          {
            echo "buildspec<<EOF"
            jq -c . buildspec.json
            echo "EOF"
          } >> "$GITHUB_OUTPUT"
          echo "ImageVersion=$ImageVersion" >> "$GITHUB_OUTPUT"

      - name: Set up macOS Signing Certificates
        uses: ./.github/actions/setup-macos-codesigning
        id: codesign
        if: ${{ env.CODESIGN_OK == 'true' }}
        with:
          MACOS_SIGNING_APPLICATION_IDENTITY: ${{ secrets.MACOS_SIGNING_APPLICATION_IDENTITY }}
          MACOS_SIGNING_CERT: ${{ secrets.MACOS_SIGNING_CERT }}
          MACOS_SIGNING_CERT_PASSWORD: ${{ secrets.MACOS_SIGNING_CERT_PASSWORD }}

      - name: Install dependencies via Homebrew
        run: brew install -q cmake

      - name: Download dependencies
        run: cmake -P scripts/download-deps.cmake

      - name: Build libobs
        run: scripts/build-obs-studio-macos.sh

      - name: Configure
        env:
          CODESIGN_IDENT: ${{ steps.codesign.outputs.CODESIGN_IDENT }}
          CODESIGN_TEAM: ${{ steps.codesign.outputs.CODESIGN_TEAM }}
        run: cmake --preset macos-ci

      - name: Build
        run: cmake --build --preset macos-ci

      - name: Package
        env:
          MACOS_SIGNING_APPLICATION_IDENTITY: ${{ secrets.MACOS_SIGNING_APPLICATION_IDENTITY }}
          MACOS_SIGNING_INSTALLER_IDENTITY: ${{ secrets.MACOS_SIGNING_INSTALLER_IDENTITY }}
          BUNDLE_ID: ${{ fromJson(steps.metadata.outputs.buildspec).platformConfig.macos.bundleId }}
          DISPLAY_NAME: ${{ fromJson(steps.metadata.outputs.buildspec).displayName }}
          PKG_NAME: ${{ fromJson(steps.metadata.outputs.buildspec).name }}-${{ fromJson(steps.metadata.outputs.buildspec).version }}-macos-universal.pkg
          VERSION: ${{ fromJson(steps.metadata.outputs.buildspec).version }}
        run: |
          cmake --install build_macos --config RelWithDebInfo --prefix "release/payload/Library/Application Support/obs-studio/plugins" --strip

          codesign --force --deep --options runtime --timestamp \
            --sign "$MACOS_SIGNING_APPLICATION_IDENTITY" \
            "release/payload/Library/Application Support/obs-studio/plugins/"*.plugin

          pkgbuild \
            --root release/payload \
            --identifier "$BUNDLE_ID" \
            --version "$VERSION" \
            release/component.pkg

          {
            printf '<?xml version="1.0" encoding="utf-8"?>\n'
            printf '<installer-gui-script minSpecVersion="2">\n'
            printf '  <title>%s</title>\n' "$DISPLAY_NAME"
            printf '  <options customize="never" require-scripts="false" hostArchitectures="x86_64,arm64"/>\n'
            printf '  <domains enable_localSystem="false" enable_currentUserHome="true" enable_anywhere="false"/>\n'
            printf '  <choices-outline>\n'
            printf '      <line choice="default"/>\n'
            printf '  </choices-outline>\n'
            printf '  <choice id="default" title="%s" visible="false">\n' "$DISPLAY_NAME"
            printf '    <pkg-ref id="%s"/>\n' "$BUNDLE_ID"
            printf '  </choice>\n'
            printf '  <pkg-ref id="%s" version="%s" onConclusion="none" auth="none">component.pkg</pkg-ref>\n' "$BUNDLE_ID" "$VERSION"
            printf '</installer-gui-script>\n'
          } | tee release/distribution.xml

          productbuild \
            --distribution release/distribution.xml \
            --package-path release \
            --sign "$MACOS_SIGNING_INSTALLER_IDENTITY" \
            "release/$PKG_NAME"

      - name: Notarize Installer
        if: env.CODESIGN_OK == 'true' && startsWith(github.ref, 'refs/tags/')
        env:
          APPLE_ID: ${{ secrets.MACOS_NOTARIZATION_USERNAME }}
          APPLE_PASSWORD: ${{ secrets.MACOS_NOTARIZATION_PASSWORD }}
          TEAM_ID: ${{ steps.codesign.outputs.CODESIGN_TEAM }}
        run: |
          xcrun notarytool submit release/*-macos-universal.pkg \
            --apple-id "$APPLE_ID" \
            --password "$APPLE_PASSWORD" \
            --team-id "$TEAM_ID" \
            --wait

          xcrun stapler staple release/*-macos-universal.pkg

      - name: Upload pkg
        uses: actions/upload-artifact@v6
        with:
          name: ${{ fromJson(steps.metadata.outputs.buildspec).name }}-pkg-macos-universal-${{ github.run_number }}
          path: release/${{ fromJson(steps.metadata.outputs.buildspec).name }}-*.pkg
          if-no-files-found: error

      - name: Zip dSYM
        env:
          PLUGIN_NAME: ${{ fromJson(steps.metadata.outputs.buildspec).name }}
          FILE_NAME: ${{ fromJson(steps.metadata.outputs.buildspec).name }}-${{ fromJson(steps.metadata.outputs.buildspec).version }}-macos-universal.dSYM.zip
        run: |
          cd build_macos/RelWithDebInfo
          zip -r "$FILE_NAME" "$PLUGIN_NAME.plugin.dSYM"
          echo "dSYM zipped successfully."

      - name: Upload dSYM
        uses: actions/upload-artifact@v6
        with:
          name: ${{ fromJson(steps.metadata.outputs.buildspec).name }}-pkg-macos-universal-${{ github.run_number }}-dsym
          path: build_macos/RelWithDebInfo/${{ fromJson(steps.metadata.outputs.buildspec).name }}-*.dSYM.zip
          if-no-files-found: error

      - name: Save libobs cache
        uses: actions/cache/save@v5
        continue-on-error: true
        with:
          path: |
            .deps/Frameworks
            .deps/include
            .deps/lib
            .deps/obs-studio-${{ fromJson(steps.metadata.outputs.buildspec).dependencies.obs-studio.version }}
          key: macos-libobs-${{ hashFiles('buildspec.json') }}-${{ runner.arch }}-${{ steps.metadata.outputs.ImageVersion }}

  ubuntu-deploy:
    name: Ubuntu Deploy

    runs-on: ubuntu-24.04
    timeout-minutes: 30
    environment: production-ubuntu

    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          submodules: recursive

      - name: Read metadata
        id: metadata
        run: |
          {
            echo "buildspec<<EOF"
            jq -c . buildspec.json
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Install system dependencies on Ubuntu
        run: |
          echo "man-db man-db/auto-update boolean false" | sudo debconf-set-selections
          sudo apt-get remove --purge -y man-db
          sudo add-apt-repository -y ppa:obsproject/obs-studio
          sudo apt-get update
          sudo apt-get install -y eatmydata
          sudo eatmydata apt-get install -y --no-install-recommends \
            cmake \
            libgles2-mesa-dev \
            libgtest-dev \
            libqt6svg6-dev \
            libsimde-dev \
            ninja-build \
            obs-studio \
            pkg-config \
            qt6-base-dev \
            qt6-base-private-dev

      - name: Configure
        run: cmake --preset ubuntu-x86_64

      - name: Build
        run: cmake --build --preset ubuntu-x86_64

      - name: Package
        working-directory: ${{ github.workspace }}/build_x86_64
        run: cpack -G DEB

      - name: Upload deb
        uses: actions/upload-artifact@v6
        with:
          name: ${{ fromJson(steps.metadata.outputs.buildspec).name }}-deb-ubuntu-24.04-x86_64-${{ github.run_number }}
          path: release/*.deb
          if-no-files-found: error

      - name: Upload ddeb
        uses: actions/upload-artifact@v6
        with:
          name: ${{ fromJson(steps.metadata.outputs.buildspec).name }}-deb-ubuntu-24.04-x86_64-${{ github.run_number }}-dbgsym
          path: release/*.ddeb
          if-no-files-found: error

  windows-deploy:
    name: Windows Deploy

    runs-on: windows-2022
    timeout-minutes: 30
    environment: production-windows

    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          submodules: recursive

      - name: Read metadata
        id: metadata
        shell: bash
        run: |
          {
            echo "buildspec<<EOF"
            jq -c . buildspec.json
            echo "EOF"
          } >> "$GITHUB_OUTPUT"
          echo "ImageVersion=$ImageVersion" >> "$GITHUB_OUTPUT"

      - name: Download dependencies
        run: cmake -P scripts/download-deps.cmake

      - name: Build libobs
        shell: pwsh
        run: ./scripts/build-obs-studio-windows.ps1

      - name: Configure
        run: cmake --preset windows-ci-x64

      - name: Build
        run: cmake --build --preset windows-ci-x64

      - name: Package
        shell: pwsh
        env:
          PLUGIN_NAME: ${{ fromJson(steps.metadata.outputs.buildspec).name }}
          PLUGIN_VERSION: ${{ fromJson(steps.metadata.outputs.buildspec).version }}
        run: |
          $InstallDir = "release/package"
          cmake --install build_x64 --config RelWithDebInfo --prefix $InstallDir

          $SymbolsDir = "release/symbols"
          New-Item -ItemType Directory -Path $SymbolsDir -Force | Out-Null

          Get-ChildItem -Path $InstallDir -Filter "*.pdb" -Recurse | ForEach-Object {
              $RelativePath = [System.IO.Path]::GetRelativePath($InstallDir, $_.DirectoryName)
              $DestDir = Join-Path $SymbolsDir $RelativePath
              New-Item -ItemType Directory -Path $DestDir -Force | Out-Null

              Move-Item -Path $_.FullName -Destination $DestDir
          }

          $MainZip = "release/$env:PLUGIN_NAME-$env:PLUGIN_VERSION-windows-x64.zip"
          Compress-Archive -Path "$InstallDir/*" -DestinationPath $MainZip -Force

          $PdbZip = "release/$env:PLUGIN_NAME-$env:PLUGIN_VERSION-windows-x64-pdb.zip"
          Compress-Archive -Path "$SymbolsDir/*" -DestinationPath $PdbZip -Force

      - name: Upload Binary
        uses: actions/upload-artifact@v6
        with:
          name: ${{ fromJson(steps.metadata.outputs.buildspec).name }}-binary-windows-x64-${{ github.run_number }}
          path: release/${{ fromJson(steps.metadata.outputs.buildspec).name }}-${{ fromJson(steps.metadata.outputs.buildspec).version }}-windows-x64.zip

      - name: Upload PDB
        uses: actions/upload-artifact@v6
        with:
          name: ${{ fromJson(steps.metadata.outputs.buildspec).name }}-binary-windows-x64-${{ github.run_number }}-pdb
          path: release/${{ fromJson(steps.metadata.outputs.buildspec).name }}-${{ fromJson(steps.metadata.outputs.buildspec).version }}-windows-x64-pdb.zip

      - name: Save libobs cache
        uses: actions/cache/save@v5
        id: libobs-cache
        with:
          path: |
            .deps/bin
            .deps/cmake
            .deps/include
            .deps/lib
            .deps/obs-studio-${{ fromJson(steps.metadata.outputs.buildspec).dependencies.obs-studio.version }}
          key: ${{ runner.os }}-libobs-${{ hashFiles('buildspec.json') }}-${{ runner.arch }}-${{ steps.metadata.outputs.ImageVersion }}

  create-release:
    name: Create Release

    runs-on: ubuntu-24.04
    if: startsWith(github.ref, 'refs/tags/')
    needs: [macos-deploy, ubuntu-deploy, windows-deploy ]

    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Read metadata
        id: metadata
        run: |
          {
            echo "buildspec<<EOF"
            jq -c . buildspec.json
            echo "EOF"
          } >> "$GITHUB_OUTPUT"
          echo "ImageVersion=$ImageVersion" >> "$GITHUB_OUTPUT"

      - name: Download macOS Installer
        uses: actions/download-artifact@v7
        with:
          name: ${{ fromJson(steps.metadata.outputs.buildspec).name }}-pkg-macos-universal-${{ github.run_number }}

      - name: Download macOS dSYM
        uses: actions/download-artifact@v7
        with:
          name: ${{ fromJson(steps.metadata.outputs.buildspec).name }}-pkg-macos-universal-${{ github.run_number }}-dsym

      - name: Download Ubuntu deb
        uses: actions/download-artifact@v7
        with:
          name: ${{ fromJson(steps.metadata.outputs.buildspec).name }}-deb-ubuntu-24.04-x86_64-${{ github.run_number }}

      - name: Download Ubuntu ddeb
        uses: actions/download-artifact@v7
        with:
          name: ${{ fromJson(steps.metadata.outputs.buildspec).name }}-deb-ubuntu-24.04-x86_64-${{ github.run_number }}-dbgsym

      - name: Download Windows Binary
        uses: actions/download-artifact@v7
        with:
          name: ${{ fromJson(steps.metadata.outputs.buildspec).name }}-binary-windows-x64-${{ github.run_number }}

      - name: Download Windows PDB
        uses: actions/download-artifact@v7
        with:
          name: ${{ fromJson(steps.metadata.outputs.buildspec).name }}-binary-windows-x64-${{ github.run_number }}-pdb

      - name: Create Draft Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PLUGIN_NAME: ${{ fromJson(steps.metadata.outputs.buildspec).name }}
        run: |
          TAG_NAME=${GITHUB_REF#refs/tags/}

          PRERELEASE_FLAG=""
          if [[ "$TAG_NAME" == *"-"* ]]; then
            PRERELEASE_FLAG="--prerelease"
          fi

          gh release create "$TAG_NAME" \
            $PLUGIN_NAME-*.pkg \
            $PLUGIN_NAME-*.dSYM.zip \
            $PLUGIN_NAME-*.deb \
            $PLUGIN_NAME-*.ddeb \
            $PLUGIN_NAME-*.zip \
            --draft \
            --generate-notes \
            --title "$TAG_NAME" \
            $PRERELEASE_FLAG
